<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AMBA STOCK</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 30px;
      background-color: #f0f2f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 32px;
      color: #2c3e50;
    }

    .input-area {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 30px;
    }

    input[type="text"],
    input[type="date"] {
      padding: 12px 20px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      outline: none;
      transition: 0.3s;
    }

    button {
      padding: 12px 20px;
      font-size: 16px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background-color: #2980b9;
    }

    .summary {
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      color: black;
      background-color: #fff;
      padding: 15px;
      margin: 20px auto;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: fit-content;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      width: 100%;
      gap: 20px;
    }

    .card {
      background-color: #fff;
      flex: 1;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .card h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 20px;
      color: #34495e;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #ecf0f1;
    }

    tr:hover {
      background-color: #f9f9f9;
    }

    @media screen and (max-width: 800px) {
      .row {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

  <h1>AMBA STOCK</h1>
  <div class="input-area">
    <input type="text" id="skuInput" placeholder="Enter SKU (e.g., 471MPD)">
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <button onclick="fetchStock()">Fetch Stock</button>
    <button onclick="exportPDF()">Export PDF</button>
    <button onclick="exportExcel()">Export Excel</button>
  </div>

  <div class="summary" id="remainingDisplay">Remaining Stock: -</div>

  <div class="container">
    <div class="row">
      <div class="card">
        <h2>In Details</h2>
        <div id="inDetails"></div>
      </div>
      <div class="card">
        <h2>Out Details</h2>
        <div id="outDetails"></div>
      </div>
    </div>
  </div>

  <script>
    const inCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT91A_LuXxb_QVO5Q8iidQyQQCFFhkSkRnVlgJQvhgkeluHEdKJUbht_WRTbwMClofYiDm5Ej-Zw311/pub?gid=1865060622&single=true&output=csv';
    const outCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5ZO4mvjCEAbv4l3-bZUOwBvLl_d6aHPtvYinZPxZ1NpCq4nyjVFrFV_nDXIRpga-htqmsCQm04e3b/pub?gid=0&single=true&output=csv';

    async function fetchCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      const rows = text.trim().split('\n').map(row => row.split(','));
      const headers = rows[0].map(h => h.trim().toLowerCase());
      return rows.slice(1).map(row => {
        const obj = {};
        row.forEach((val, i) => {
          obj[headers[i]] = val.trim();
        });
        return obj;
      });
    }

    function parseDate(str) {
      if (!str) return null;
      if (str.includes('/')) {
        const [day, month, year] = str.split('/');
        return new Date(`${year}-${month}-${day}`);
      }
      return new Date(str);
    }

    async function fetchStock() {
      const sku = document.getElementById('skuInput').value.trim();
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      if (!sku) return alert("Please enter a SKU");

      const inData = await fetchCSV(inCsvUrl);
      const outData = await fetchCSV(outCsvUrl);

      function isWithinDate(dateStr) {
        const entryDate = parseDate(dateStr);
        if (!entryDate || isNaN(entryDate)) return false;
        if (startDate && entryDate < parseDate(startDate)) return false;
        if (endDate && entryDate > parseDate(endDate)) return false;
        return true;
      }

      const filteredIn = inData.filter(row => {
        return row['sku'] === sku && row['in/out'] === 'In' && isWithinDate(row['date']);
      });

      const filteredOut = outData.filter(row => {
        return row['sku'] === sku && isWithinDate(row['date']);
      });

      let totalIn = 0, inRowsHtml = '';
      for (let row of filteredIn) {
        const qty = parseInt(row['quantity']) || 0;
        totalIn += qty;
        let loadNo = row['s o number/ load no']?.trim();
        if (!loadNo) {
          loadNo = 'Opening Stock';
        }
        inRowsHtml += `<tr><td>${row['date']}</td><td>${row['sku']}</td><td>${qty}</td><td>${loadNo}</td></tr>`;
      }
      inRowsHtml = `
        <div style="text-align:right; font-weight:bold; margin-bottom:10px;">Total In: ${totalIn}</div>
        <table>
          <tr><th>Date</th><th>SKU</th><th>Qty</th><th>Load No</th></tr>
          ${inRowsHtml}
        </table>`;

      let totalOut = 0, outRowsHtml = '';
      for (let row of filteredOut) {
        const qty = parseInt(row['qty']) || 0;
        totalOut += qty;
        outRowsHtml += `<tr><td>${row['date']}</td><td>${row['sku']}</td><td>${qty}</td><td>${row['party name'] || ''}</td></tr>`;
      }
      outRowsHtml = `
        <div style="text-align:right; font-weight:bold; margin-bottom:10px;">Total Out: ${totalOut}</div>
        <table>
          <tr><th>Date</th><th>SKU</th><th>Qty</th><th>Party Name</th></tr>
          ${outRowsHtml}
        </table>`;

      const remaining = totalIn - totalOut;

      document.getElementById('inDetails').innerHTML = inRowsHtml;
      document.getElementById('outDetails').innerHTML = outRowsHtml;
      document.getElementById('remainingDisplay').innerHTML = `Remaining Stock: <span style="color: green;">${remaining}</span>`;
    }

    function exportPDF() {
      const sku = document.getElementById("skuInput").value.trim() || "Report";
      const element = document.createElement("div");
      element.innerHTML = `
        <h2 style="text-align:center;">AMBA STOCK REPORT</h2>
        ${document.getElementById("remainingDisplay").outerHTML}
        <h2>In Details</h2>${document.getElementById("inDetails").innerHTML}
        <h2>Out Details</h2>${document.getElementById("outDetails").innerHTML}
      `;
      html2pdf().from(element).save(`AMBA_Stock_Report_${sku}.pdf`);
    }

    function exportExcel() {
      const sku = document.getElementById("skuInput").value.trim() || "Report";
      const wb = XLSX.utils.book_new();
      const inTable = document.getElementById("inDetails").querySelector("table");
      const outTable = document.getElementById("outDetails").querySelector("table");

      const inSheet = XLSX.utils.table_to_sheet(inTable);
      const outSheet = XLSX.utils.table_to_sheet(outTable);

      XLSX.utils.book_append_sheet(wb, inSheet, "In Details");
      XLSX.utils.book_append_sheet(wb, outSheet, "Out Details");

      XLSX.writeFile(wb, `AMBA_Stock_Report_${sku}.xlsx`);
    }
  </script>

</body>
</html>
